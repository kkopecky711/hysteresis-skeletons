---
title: "Fore reef hysteresis experiment"
author: "Kai Kopecky"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(janitor)
library(Manu)
library(vegan)
```

```{r}

# Read in data and create summary table
macroalgae <- read_csv("Data/material legacy hysteresis experiment.csv") %>% 
  clean_names() %>% 
  mutate(structure_ttt = as.factor(structure_ttt),
         initial_community = as.factor(initial_community),
         herbivory_ttt = as.factor(herbivory_ttt),
         herb_ttt_cm = as.factor(herb_ttt_cm))

macroalgae.summary <- macroalgae %>%
  group_by(structure_ttt, initial_community, herb_ttt_cm) %>% 
  summarize(norm_macro.mean = mean(mac_cover_normalized),
            norm_macro.se = sd(mac_cover_normalized)/sqrt(n()))

macroalgae.summary$herb_ttt_cm <- ordered(macroalgae.summary$herb_ttt_cm, levels = c("2.5", "5", "7.5", "10", "Ambient"))

macroalgae.summary$structure_ttt <- ordered(macroalgae.summary$structure_ttt, levels = c("No structure", "Dead skeletons"))

ggplot(macroalgae.summary, aes(x = herb_ttt_cm, y = norm_macro.mean, color = initial_community)) +
  geom_line(aes(group = initial_community)) +
  geom_errorbar(aes(ymax = norm_macro.mean + norm_macro.se,
                    ymin = norm_macro.mean - norm_macro.se),
                width = 0.1,
                color = "black") +
  geom_point(size = 3,
             color = "black") +
  geom_point(size = 2) +
  labs(y = "Normalized macroalgae cover",
       x = "Herbivory treatment") +
  scale_color_manual(name = "Initial community state",
                     values = c("#A1B654", "#287DAB"),
                     labels = c("Macroalgae", "Turf algae")) +
  scale_y_continuous(limits = c(0,1.2),
                     breaks = c(0.0, 0.25, 0.5, 0.75, 1.0)) +
  facet_wrap(~structure_ttt) +
  theme_classic(base_size = 12)

```

```{r Statistics}

## No structure
# Dataframe with only no structure treatment
no_structure <- macroalgae %>% 
  filter(structure_ttt == "No structure") %>% 
  mutate(mac_cover.prop = (mac_cover_percent + 0.001)/100,
         mac_cover.asin = asin(sqrt(mac_cover.prop)))

hist(no_structure$mac_cover.prop)
hist(no_structure$mac_cover.asin)

# Run PermANOVA of macroalgae cover ~ herbivory treatment for no structure treatment
no_structure.perm <- adonis2(no_structure$mac_cover.asin ~ herb_ttt_cm*initial_community, data = no_structure)
print(no_structure.perm)

## With structure
# Create separate dataframes for each structure treatment
structure <- macroalgae %>% 
  filter(structure_ttt == "Dead skeletons") %>% 
  mutate(mac_cover.prop = (mac_cover_percent + 0.001)/100,
         mac_cover.asin = asin(sqrt(mac_cover.prop)))

hist(structure$mac_cover.asin)

# Run PermANOVA of macroalgae cover ~ herbivory treatment for with structure treatment
structure_perm <- adonis2(structure$mac_cover.asin ~ herb_ttt_cm*initial_community, data = structure)
print(structure_perm)

```


